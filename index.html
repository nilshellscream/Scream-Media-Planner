<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scream Reach Planner</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Archivo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Archivo', sans-serif; }
        @media print {
            .no-print { display: none !important; }
            body { background: white !important; }
        }
        .table-number {
            font-family: 'Archivo', sans-serif;
            font-variant-numeric: tabular-nums;
        }
        .editable-cell { 
            transition: all 0.2s; 
            border-bottom: 1px solid transparent; 
            padding: 4px 12px; 
            border-radius: 4px; 
            background: transparent;
            font-family: 'Archivo', sans-serif;
        }
        .editable-cell:hover { background: rgba(255,255,255,0.6); border-bottom-color: #00423344; }
        .editable-cell:focus { outline: none; background: white; border-bottom-color: #004233; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        
        .factor-input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            padding: 4px 8px;
            width: 50px;
            text-align: center;
            color: white;
            font-weight: bold;
            outline: none;
            transition: all 0.2s;
        }

        /* Custom scrollbar for better look */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #004233; border-radius: 10px; }
    </style>
</head>
<body class="bg-[#fff1e4]">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;

        const Icon = ({ name, size = 16, className = "" }) => {
            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            }, [name]);
            return <i data-lucide={name} style={{ width: size, height: size }} className={className}></i>;
        };

        const BASE_AUDIENCE_NAME = "A3-99";
        const BASE_AUDIENCE_SIZE = 10184000;
        const COLORS = {
            primary: '#004233',
            secondary: '#fff1e4',
            border: '#dcece8',
            barBg: '#e0ede9' // Light green for the 100% background
        };
        const LOGO_URL = "https://cdn.prod.website-files.com/6659ca39bd3186a564743e73/6659d12099b696012798747a_scream-logo-vit.svg";

        const App = () => {
            const [targetName, setTargetName] = useState("W19-35");
            const [targetSize, setTargetSize] = useState(1071000);
            const [useDeduplication, setUseDeduplication] = useState(true);
            const [correctionFactor, setCorrectionFactor] = useState(0.9);
            const [copyFeedback, setCopyFeedback] = useState(false);
            const [channels, setChannels] = useState([
                { id: 1, name: "TV4 Riks", brutto: 3400000, netto: 726000, mlgr_traff: 100 },
                { id: 2, name: "YouTube", brutto: 3700000, netto: 597000, mlgr_traff: 100 },
                { id: 3, name: "Facebook/IG", brutto: 3100000, netto: 479487, mlgr_traff: 100 },
                { id: 4, name: "Podcast", brutto: 1700000, netto: 697000, mlgr_traff: 100 },
            ]);

            const formatNumber = (num) => new Intl.NumberFormat('sv-SE').format(Math.round(num));
            const formatDecimal = (num) => new Intl.NumberFormat('sv-SE', { minimumFractionDigits: 1, maximumFractionDigits: 1 }).format(num);
            
            const parseInput = (val) => {
                if (typeof val !== 'string') return val;
                const clean = val.replace(/\s/g, '').replace(/%/g, '').replace(/,/g, '.');
                return clean === '' ? 0 : Number(clean);
            };

            const handleInputChange = (id, field, value) => {
                setChannels(channels.map(ch => ch.id === id ? { ...ch, [field]: value } : ch));
            };

            const addChannel = () => {
                const newId = channels.length > 0 ? Math.max(...channels.map(c => c.id)) + 1 : 1;
                setChannels([...channels, { id: newId, name: `Kanal ${newId}`, brutto: 0, netto: 0, mlgr_traff: 100 }]);
            };

            const removeChannel = (id) => setChannels(channels.filter(c => c.id !== id));

            const calculateNetto = (chanList, universeSize, isMlgr = false) => {
                if (chanList.length === 0) return 0;
                let probNoHit = 1.0;
                chanList.forEach(ch => {
                    const factor = isMlgr ? (Number(ch.mlgr_traff) / 100) : 1;
                    let reach = (Number(ch.netto) * factor) / universeSize;
                    probNoHit *= (1 - Math.min(reach, 1));
                });
                return (1 - probNoHit) * (useDeduplication ? correctionFactor : 1) * universeSize;
            };

            const totalBrutto = channels.reduce((sum, ch) => sum + Number(ch.brutto), 0);
            const totalNettoA399 = calculateNetto(channels, BASE_AUDIENCE_SIZE);
            const totalNettoMlgr = calculateNetto(channels, targetSize, true);
            const totalOTS = totalNettoA399 > 0 ? totalBrutto / totalNettoA399 : 0;
            const reachA399Pct = (totalNettoA399 / BASE_AUDIENCE_SIZE) * 100;
            const reachMlgrPct = (totalNettoMlgr / targetSize) * 100;

            const reachData = useMemo(() => {
                let list = [];
                let prevReach = 0;
                for (let i = 1; i <= channels.length; i++) {
                    const subList = channels.slice(0, i);
                    const currentReach = (calculateNetto(subList, targetSize, true) / targetSize) * 100;
                    list.push({
                        name: channels[i-1].name || `Kanal ${i}`,
                        totalReach: currentReach,
                        incremental: currentReach - prevReach
                    });
                    prevReach = currentReach;
                }
                return list;
            }, [channels, targetSize, useDeduplication, correctionFactor]);

            const copySummary = () => {
                const summary = `SCREAM MEDIA PLANNER - SAMMANFATTNING\nMålgrupp: ${targetName}\nRäckvidd (${targetName}): ${formatDecimal(reachMlgrPct)}%`;
                navigator.clipboard.writeText(summary).then(() => {
                    setCopyFeedback(true);
                    setTimeout(() => setCopyFeedback(false), 2000);
                });
            };

            const DonutGraph = ({ percentage, label, icon }) => (
                <div className="flex flex-col items-center flex-1">
                    <div className="relative w-24 h-24 md:w-32 md:h-32">
                        <svg viewBox="0 0 36 36" className="w-full h-full -rotate-90">
                            <circle cx="18" cy="18" r="15.5" fill="none" stroke="#f3f4f6" strokeWidth="3.5" />
                            <circle cx="18" cy="18" r="15.5" fill="none" stroke={COLORS.primary} strokeWidth="3.5" strokeDasharray={`${Math.min(percentage, 100)}, 100`} strokeLinecap="round" className="transition-all duration-700" />
                        </svg>
                        <div className="absolute inset-0 flex flex-col items-center justify-center">
                            <Icon name={icon} size={14} className="opacity-20 mb-0.5" />
                            <span className="text-lg font-bold table-number">{Math.round(percentage)}%</span>
                        </div>
                    </div>
                    <p className="mt-2 text-[9px] font-bold uppercase tracking-widest opacity-60">{label}</p>
                </div>
            );

            return (
                <div className="min-h-screen py-6 px-4 print:p-0">
                    <div className="max-w-6xl mx-auto space-y-4">
                        
                        {/* HEADER */}
                        <div className="bg-[#004233] text-[#fff1e4] p-5 rounded-2xl shadow-lg flex flex-col md:flex-row justify-between items-center gap-4">
                            <div className="flex items-center gap-6">
                                <img src={LOGO_URL} alt="Scream" className="h-6" />
                                <h1 className="text-2xl font-bold text-white">Reach Planner</h1>
                            </div>
                            <div className="flex flex-wrap justify-center gap-3 no-print">
                                <div className="flex items-center gap-2 bg-white/5 px-3 py-1 rounded-full border border-white/10">
                                    <span className="text-[10px] font-bold uppercase tracking-widest opacity-60">Faktor:</span>
                                    <input 
                                        type="text"
                                        value={correctionFactor} 
                                        onChange={(e) => setCorrectionFactor(parseInput(e.target.value))}
                                        className="factor-input text-xs table-number"
                                    />
                                </div>
                                <button onClick={() => setUseDeduplication(!useDeduplication)} className="text-[10px] font-bold uppercase tracking-widest bg-white/10 px-4 py-2 rounded-full border border-white/20 hover:bg-white/20 transition-all">
                                    {useDeduplication ? "De-duplicerad" : "Linjär"}
                                </button>
                                <button onClick={copySummary} className="p-2 bg-white/10 rounded-lg border border-white/20 hover:bg-white/20 flex items-center gap-2 text-[10px] font-bold uppercase">
                                    <Icon name={copyFeedback ? "check" : "copy"} size={14} />
                                    {copyFeedback ? "Kopierad!" : "Kopiera"}
                                </button>
                                <button onClick={() => window.print()} className="p-2 bg-white text-[#004233] rounded-lg text-[10px] font-bold uppercase flex items-center gap-2 hover:bg-[#fff1e4] transition-all">
                                    <Icon name="download" size={14} /> PDF
                                </button>
                            </div>
                        </div>

                        {/* INFO BOXES */}
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div className="bg-white p-5 rounded-xl border border-[#dcece8] shadow-sm flex items-center justify-between">
                                <div className="flex items-center gap-4">
                                    <div className="w-10 h-10 bg-[#f4f9f7] rounded-lg flex items-center justify-center">
                                        <Icon name="users" className="text-[#004233]" size={20} />
                                    </div>
                                    <div>
                                        <span className="text-[10px] font-bold uppercase tracking-wider text-[#004233] opacity-40 block mb-0.5">Basuniversum</span>
                                        <span className="text-sm font-bold text-[#004233] uppercase">{BASE_AUDIENCE_NAME}</span>
                                    </div>
                                </div>
                                <div className="bg-[#f4f9f7] px-4 py-2 rounded-lg border border-[#e0ede9]">
                                    <span className="text-xl font-bold text-[#004233] table-number tracking-tight">
                                        {formatNumber(BASE_AUDIENCE_SIZE)}
                                    </span>
                                </div>
                            </div>

                            <div className="bg-white p-5 rounded-xl border border-[#dcece8] shadow-sm flex items-center justify-between">
                                <div className="flex items-center gap-4 flex-1">
                                    <div className="w-10 h-10 bg-[#f4f9f7] rounded-lg flex items-center justify-center">
                                        <Icon name="target" className="text-[#004233]" size={20} />
                                    </div>
                                    <div className="flex-1">
                                        <span className="text-[10px] font-bold uppercase tracking-wider text-[#004233] opacity-40 block mb-0.5">Målgrupp</span>
                                        <input 
                                            value={targetName} 
                                            onChange={e => setTargetName(e.target.value)} 
                                            className="w-full text-sm font-bold text-[#004233] bg-transparent outline-none uppercase hover:bg-[#f4f9f7] rounded px-1 -ml-1 transition-colors" 
                                        />
                                    </div>
                                </div>
                                <div className="bg-[#f4f9f7] px-4 py-2 rounded-lg border border-[#e0ede9] ml-4">
                                    <input 
                                        value={formatNumber(targetSize)} 
                                        onChange={e => setTargetSize(parseInput(e.target.value))} 
                                        className="bg-transparent outline-none text-right w-32 text-xl font-bold text-[#004233] table-number tracking-tight" 
                                    />
                                </div>
                            </div>
                        </div>

                        {/* TABLE */}
                        <div className="bg-white rounded-xl shadow-sm border border-[#dcece8] overflow-hidden overflow-x-auto">
                            <table className="w-full text-left border-collapse min-w-[900px]">
                                <thead className="bg-[#f9fdfb] text-[10px] uppercase font-bold tracking-widest opacity-60 border-b">
                                    <tr>
                                        <th className="p-4">Kanalnamn</th>
                                        <th className="p-4 text-right">Brutto Imps</th>
                                        <th className="p-4 text-right">Netto Imps</th>
                                        <th className="p-4 text-right">Mlgr Träff</th>
                                        <th className="p-4 text-right bg-[#f4f9f7]">OTS</th>
                                        <th className="p-4 text-right bg-[#f4f9f7]">1+ {BASE_AUDIENCE_NAME}</th>
                                        <th className="p-4 text-right bg-[#004233] text-white font-bold">1+ {targetName}</th>
                                        <th className="p-4 no-print"></th>
                                    </tr>
                                </thead>
                                <tbody className="text-xs">
                                    {channels.map(ch => (
                                        <tr key={ch.id} className="border-b border-[#f0f7f5] hover:bg-[#fffcf9]">
                                            <td className="p-1 px-2"><input value={ch.name} onChange={e => handleInputChange(ch.id, 'name', e.target.value)} className="editable-cell w-full" /></td>
                                            <td className="p-1 px-2"><input value={formatNumber(ch.brutto)} onChange={e => handleInputChange(ch.id, 'brutto', parseInput(e.target.value))} className="editable-cell w-full text-right table-number" /></td>
                                            <td className="p-1 px-2"><input value={formatNumber(ch.netto)} onChange={e => handleInputChange(ch.id, 'netto', parseInput(e.target.value))} className="editable-cell w-full text-right table-number" /></td>
                                            <td className="p-1 px-2">
                                                <div className="flex items-center justify-end">
                                                    <input value={ch.mlgr_traff} onChange={e => handleInputChange(ch.id, 'mlgr_traff', parseInput(e.target.value))} className="editable-cell w-16 text-right table-number" />
                                                    <span className="text-[10px] opacity-30 font-bold mr-2">%</span>
                                                </div>
                                            </td>
                                            <td className="p-4 text-right table-number bg-[#f4f9f7]">{formatDecimal(ch.netto > 0 ? ch.brutto/ch.netto : 0)}</td>
                                            <td className="p-4 text-right table-number bg-[#f4f9f7]">{formatDecimal((ch.netto/BASE_AUDIENCE_SIZE)*100)}%</td>
                                            <td className="p-4 text-right table-number font-bold bg-[#f4f9f7] text-[#004233]">{formatDecimal(((ch.netto*(ch.mlgr_traff/100))/targetSize)*100)}%</td>
                                            <td className="p-1 text-center no-print"><button onClick={() => removeChannel(ch.id)} className="text-red-200 hover:text-red-600"><Icon name="trash-2" size={14}/></button></td>
                                        </tr>
                                    ))}
                                </tbody>
                                <tfoot className="bg-[#004233] text-white">
                                    <tr className="text-xs">
                                        <td className="p-4 uppercase text-[10px] font-bold">Totalt</td>
                                        <td className="p-4 text-right table-number font-bold">{formatNumber(totalBrutto)}</td>
                                        <td className="p-4 text-right table-number font-bold">{formatNumber(totalNettoA399)}</td>
                                        <td></td>
                                        <td className="p-4 text-right table-number font-bold">{formatDecimal(totalOTS)}</td>
                                        <td className="p-4 text-right table-number font-bold">{formatDecimal(reachA399Pct)}%</td>
                                        <td className="p-4 text-right table-number font-bold">{formatDecimal(reachMlgrPct)}%</td>
                                        <td className="no-print"></td>
                                    </tr>
                                </tfoot>
                            </table>
                            <button onClick={addChannel} className="w-full py-3 bg-[#f4f9f7] text-[#004233] text-[9px] font-bold uppercase tracking-widest flex items-center justify-center gap-2 hover:bg-[#e8f5e9] no-print">
                                <Icon name="plus" size={12} /> Lägg till rad
                            </button>
                        </div>

                        {/* GRAPHS */}
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {/* DONUT GRAPH BOX */}
                            <div className="bg-white p-6 rounded-xl border border-[#dcece8] shadow-sm">
                                <h3 className="text-[10px] font-bold uppercase tracking-widest opacity-60 mb-8">Total Räckvidd</h3>
                                <div className="flex flex-row justify-around items-center h-48">
                                    <DonutGraph percentage={reachMlgrPct} label={targetName} icon="target" />
                                    <DonutGraph percentage={reachA399Pct} label={BASE_AUDIENCE_NAME} icon="users" />
                                </div>
                            </div>

                            {/* UPDATED BAR GRAPH BOX */}
                            <div className="bg-white p-6 rounded-xl border border-[#dcece8] shadow-sm">
                                <h3 className="text-[10px] font-bold uppercase tracking-widest opacity-60 mb-8">Ackumulerad Räckvidd</h3>
                                <div className="h-48 flex items-end justify-between gap-3 px-2">
                                    {reachData.map((item, idx) => (
                                        <div key={idx} className="flex-1 flex flex-col items-center h-full">
                                            <div className="relative w-full h-full bg-[#f4f9f7] rounded-md overflow-hidden border border-[#e0ede9] group transition-all">
                                                {/* The Fill Bar */}
                                                <div 
                                                    className="absolute bottom-0 left-0 w-full bg-[#004233] transition-all duration-1000 ease-out"
                                                    style={{ height: `${item.totalReach}%` }}
                                                >
                                                    {/* Glow effect at top of bar */}
                                                    <div className="absolute top-0 left-0 w-full h-1 bg-white/20" />
                                                </div>
                                                
                                                {/* Percentage label floating inside or above */}
                                                <div className="absolute bottom-1 w-full text-center">
                                                    <span className={`text-[8px] font-bold table-number ${item.totalReach > 20 ? 'text-white' : 'text-[#004233] -top-5 absolute left-0 right-0'}`}>
                                                        {Math.round(item.totalReach)}%
                                                    </span>
                                                </div>
                                            </div>
                                            <span className="text-[7px] mt-2 uppercase font-bold opacity-40 truncate w-full text-center px-1" title={item.name}>
                                                {item.name}
                                            </span>
                                        </div>
                                    ))}
                                    {/* Empty state if no channels */}
                                    {channels.length === 0 && (
                                        <div className="w-full h-full flex items-center justify-center opacity-20 italic text-xs">
                                            Ingen data tillgänglig
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>

                        <div className="text-center pt-8 opacity-20 text-[8px] uppercase tracking-widest no-print">
                            Powered by Scream Reach Planner
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
